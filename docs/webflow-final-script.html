<!-- BlogFlow Script for Webflow - Final Version -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<script>
window.addEventListener('load', function() {
  console.log('[BlogFlow] Initializing...');
  setTimeout(function() {
    initBlogFlow();
  }, 1000);
});

function initBlogFlow() {
  var form = document.querySelector('form');
  if (!form) {
    console.error('[BlogFlow] No form found!');
    return;
  }
  
  // Initialize Quill
  var quillEditor = null;
  var editorElement = document.getElementById('editor');
  
  if (editorElement && typeof Quill !== 'undefined') {
    quillEditor = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Write your article content here...',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'blockquote'],
          ['clean']
        ]
      }
    });
    console.log('[BlogFlow] Quill editor initialized');
  }
  
  // Find submit button
  var submitBtn = form.querySelector('[type="submit"]') || 
                  form.querySelector('input[value*="Submit"]') ||
                  form.querySelector('button');
  
  // Override form submission
  form.onsubmit = function(e) {
    if (e && e.preventDefault) {
      e.preventDefault();
    }
    handleFormSubmit();
    return false;
  };
  
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    e.stopPropagation();
    return false;
  }, true);
  
  function handleFormSubmit() {
    console.log('[BlogFlow] Processing submission...');
    
    var originalText = submitBtn.value || submitBtn.textContent;
    submitBtn.disabled = true;
    if (submitBtn.value) {
      submitBtn.value = 'Processing...';
    } else {
      submitBtn.textContent = 'Processing...';
    }
    
    try {
      // Collect form data
      var formData = {};
      var inputs = form.querySelectorAll('input, textarea, select');
      
      for (var i = 0; i < inputs.length; i++) {
        var input = inputs[i];
        if (input.name && !input.name.startsWith('_')) {
          if (input.type === 'checkbox') {
            formData[input.name] = input.checked;
          } else if (input.type === 'radio') {
            if (input.checked) {
              formData[input.name] = input.value;
            }
          } else {
            formData[input.name] = input.value;
          }
        }
      }
      
      // Add Quill content
      if (quillEditor) {
        var delta = quillEditor.getContents();
        var text = quillEditor.getText().trim();
        var wordCount = text.split(/\s+/).filter(function(word) {
          return word.length > 0;
        }).length;
        
        if (wordCount < 50) {
          throw new Error('Article must be at least 50 words (currently ' + wordCount + ' words)');
        }
        
        formData.articleContent = delta;
      } else {
        throw new Error('Article content is required');
      }
      
      // Process tags and categories
      if (formData.tags && typeof formData.tags === 'string') {
        formData.tags = formData.tags.split(',').map(function(tag) {
          return tag.trim();
        }).filter(Boolean);
      }
      
      if (formData.categories && typeof formData.categories === 'string') {
        formData.categories = formData.categories.split(',').map(function(cat) {
          return cat.trim();
        }).filter(Boolean);
      }
      
      // Handle checkbox
      if (formData.publishNow === 'on') {
        formData.publishNow = true;
      }
      
      // Auto-generate email if not provided
      formData.authorEmail = formData.authorEmail || 'noreply@' + window.location.hostname;
      
      // Validate required fields
      if (!formData.authorName) {
        throw new Error('Author name is required');
      }
      
      if (!formData.articleTitle) {
        throw new Error('Article title is required');
      }
      
      if (!formData.metaDescription || formData.metaDescription.length < 50) {
        throw new Error('Meta description must be at least 50 characters');
      }
      
      console.log('[BlogFlow] Sending data:', formData);
      
      // Make API request
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://dominiquede-blogflow-62.deno.dev/api/webflow-form', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      xhr.onload = function() {
        try {
          var response = JSON.parse(xhr.responseText);
          console.log('[BlogFlow] Response:', response);
          
          if (xhr.status === 200 && response.success) {
            showSuccess(response);
            form.reset();
            if (quillEditor) {
              quillEditor.setText('');
            }
          } else {
            showError(response.message || 'Submission failed');
          }
        } catch (e) {
          showError('Invalid response from server');
        }
        
        submitBtn.disabled = false;
        if (submitBtn.value) {
          submitBtn.value = originalText;
        } else {
          submitBtn.textContent = originalText;
        }
      };
      
      xhr.onerror = function() {
        showError('Network error. Please check your connection.');
        submitBtn.disabled = false;
        if (submitBtn.value) {
          submitBtn.value = originalText;
        } else {
          submitBtn.textContent = originalText;
        }
      };
      
      xhr.send(JSON.stringify(formData));
      
    } catch (error) {
      console.error('[BlogFlow] Error:', error);
      showError(error.message);
      submitBtn.disabled = false;
      if (submitBtn.value) {
        submitBtn.value = originalText;
      } else {
        submitBtn.textContent = originalText;
      }
    }
  }
  
  function showSuccess(response) {
    form.style.display = 'none';
    
    var successDiv = document.createElement('div');
    successDiv.className = 'w-form-done';
    successDiv.style.display = 'block';
    successDiv.innerHTML = '<div><strong>Thank you!</strong><br>' +
      'Your article has been submitted successfully.' +
      (response.data && response.data.itemId ? '<br>Article ID: ' + response.data.itemId : '') +
      '</div>';
    
    form.parentNode.insertBefore(successDiv, form.nextSibling);
  }
  
  function showError(message) {
    var errorDiv = form.parentNode.querySelector('.w-form-fail');
    
    if (!errorDiv) {
      errorDiv = document.createElement('div');
      errorDiv.className = 'w-form-fail';
      form.parentNode.insertBefore(errorDiv, form.nextSibling);
    }
    
    errorDiv.style.display = 'block';
    errorDiv.innerHTML = '<div><strong>Error:</strong> ' + message + '</div>';
    
    setTimeout(function() {
      errorDiv.style.display = 'none';
    }, 10000);
  }
  
  console.log('[BlogFlow] Ready!');
}
</script>