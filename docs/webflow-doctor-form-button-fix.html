<!-- Simplified BlogFlow Script for Medical Professionals - FIXED FOR CUSTOM BUTTON -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<!-- Toast Notification Styles -->
<style>
.blogflow-toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  pointer-events: none;
}

.blogflow-toast {
  background: white;
  border-radius: 8px;
  padding: 16px 24px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 300px;
  max-width: 500px;
  pointer-events: auto;
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.3s ease;
}

.blogflow-toast.show {
  opacity: 1;
  transform: translateX(0);
}

.blogflow-toast.success { border-left: 4px solid #10b981; }
.blogflow-toast.error { border-left: 4px solid #ef4444; }
.blogflow-toast.warning { border-left: 4px solid #f59e0b; }
.blogflow-toast.info { border-left: 4px solid #3b82f6; }

.blogflow-toast-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.blogflow-toast.success .blogflow-toast-icon { color: #10b981; }
.blogflow-toast.error .blogflow-toast-icon { color: #ef4444; }
.blogflow-toast.warning .blogflow-toast-icon { color: #f59e0b; }
.blogflow-toast.info .blogflow-toast-icon { color: #3b82f6; }

.blogflow-toast-content { flex: 1; }
.blogflow-toast-title { font-weight: 600; margin-bottom: 4px; color: #1f2937; }
.blogflow-toast-message { font-size: 14px; color: #6b7280; line-height: 1.4; }

.blogflow-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #e5e7eb;
  border-radius: 50%;
  border-top-color: #3b82f6;
  animation: blogflow-spin 0.8s linear infinite;
  margin-left: 8px;
}

@keyframes blogflow-spin {
  to { transform: rotate(360deg); }
}

.blogflow-field-error {
  border-color: #ef4444 !important;
  background-color: #fef2f2 !important;
}

.blogflow-field-success {
  border-color: #10b981 !important;
  background-color: #f0fdf4 !important;
}

/* Quill fixes */
#editor {
  background: white !important;
  min-height: 300px !important;
}

.ql-editor {
  min-height: 250px !important;
}
</style>

<script>
// Toast notification system
var BlogFlowToast = (function() {
  var container = null;
  
  function init() {
    if (!container) {
      container = document.createElement('div');
      container.className = 'blogflow-toast-container';
      document.body.appendChild(container);
    }
  }
  
  function show(type, title, message, duration) {
    init();
    
    var toast = document.createElement('div');
    toast.className = 'blogflow-toast ' + type;
    
    var icons = {
      success: '✓',
      error: '✕',
      warning: '⚠',
      info: 'ℹ'
    };
    
    toast.innerHTML = 
      '<span class="blogflow-toast-icon">' + icons[type] + '</span>' +
      '<div class="blogflow-toast-content">' +
        '<div class="blogflow-toast-title">' + title + '</div>' +
        (message ? '<div class="blogflow-toast-message">' + message + '</div>' : '') +
      '</div>';
    
    container.appendChild(toast);
    
    setTimeout(function() {
      toast.classList.add('show');
    }, 10);
    
    if (duration !== 0) {
      setTimeout(function() {
        toast.classList.remove('show');
        setTimeout(function() {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }, duration || 5000);
    }
    
    return toast;
  }
  
  return {
    success: function(title, message, duration) {
      return show('success', title, message, duration);
    },
    error: function(title, message, duration) {
      return show('error', title, message, duration);
    },
    warning: function(title, message, duration) {
      return show('warning', title, message, duration);
    },
    info: function(title, message, duration) {
      return show('info', title, message, duration);
    }
  };
})();

// Main script - FIXED FOR CUSTOM BUTTON
window.addEventListener('load', function() {
  console.log('[BlogFlow] Medical Professional Form - Initializing...');
  
  BlogFlowToast.info('Initializing', 'Setting up article submission form...', 2000);
  
  setTimeout(function() {
    initBlogFlow();
  }, 1500);
});

function initBlogFlow() {
  var form = document.querySelector('form');
  if (!form) {
    BlogFlowToast.error('Setup Error', 'Form not found. Please contact support.', 0);
    return;
  }
  
  // Initialize Quill
  var quillEditor = null;
  var editorElement = document.getElementById('editor');
  
  if (editorElement && typeof Quill !== 'undefined') {
    // Clear any existing content
    editorElement.innerHTML = '';
    
    quillEditor = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Write your article content here...',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'blockquote'],
          ['clean']
        ]
      }
    });
    
    // Enable the editor
    quillEditor.enable();
    
    // Add word count display
    var wordCountDiv = document.createElement('div');
    wordCountDiv.style.cssText = 'text-align: right; font-size: 14px; color: #6b7280; margin-top: 8px;';
    wordCountDiv.id = 'word-count';
    wordCountDiv.textContent = '0 words (minimum 20)';
    editorElement.parentNode.insertBefore(wordCountDiv, editorElement.nextSibling);
    
    // Update word count as user types
    quillEditor.on('text-change', function() {
      var text = quillEditor.getText().trim();
      var wordCount = text.split(/\s+/).filter(function(word) {
        return word.length > 0;
      }).length;
      
      wordCountDiv.textContent = wordCount + ' words (minimum 20)';
      wordCountDiv.style.color = wordCount >= 20 ? '#10b981' : '#ef4444';
    });
  }
  
  // FIXED: Find your custom button by ID
  var submitBtn = document.getElementById('custom-submit-btn');
  
  if (!submitBtn) {
    // Fallback: try other methods
    submitBtn = form.querySelector('[type="submit"]') || 
                form.querySelector('.form-submit') ||
                form.querySelector('button');
  }
  
  if (!submitBtn) {
    BlogFlowToast.error('Setup Error', 'Submit button not found', 0);
    console.error('[BlogFlow] No submit button found! Looking for #custom-submit-btn');
    return;
  }
  
  console.log('[BlogFlow] Found submit button:', submitBtn);
  
  // Simple field validation
  setupSimpleValidation(form);
  
  // FIXED: Add click handler to your custom button
  submitBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('[BlogFlow] Custom button clicked');
    handleFormSubmit(form, quillEditor, submitBtn);
  });
  
  // Also prevent form submission if it happens
  form.onsubmit = function(e) {
    if (e && e.preventDefault) {
      e.preventDefault();
    }
    return false;
  };
  
  BlogFlowToast.success('Ready', 'You can now submit your article', 3000);
}

function setupSimpleValidation(form) {
  // Only validate required fields
  
  // Author name - just check if not empty
  var authorNameField = form.querySelector('[name="authorName"]');
  if (authorNameField) {
    authorNameField.addEventListener('blur', function() {
      if (this.value.trim().length < 2) {
        this.classList.add('blogflow-field-error');
        BlogFlowToast.info('Required', 'Please enter your name', 2000);
      } else {
        this.classList.remove('blogflow-field-error');
        this.classList.add('blogflow-field-success');
      }
    });
  }
  
  // Title - just check minimum length
  var titleField = form.querySelector('[name="articleTitle"]');
  if (titleField) {
    titleField.addEventListener('blur', function() {
      if (this.value.trim().length < 5) {
        this.classList.add('blogflow-field-error');
        BlogFlowToast.info('Required', 'Title needs at least 5 characters', 2000);
      } else {
        this.classList.remove('blogflow-field-error');
        this.classList.add('blogflow-field-success');
      }
    });
  }
  
  // Meta description - reduced requirement
  var metaField = form.querySelector('[name="metaDescription"]');
  if (metaField) {
    metaField.addEventListener('blur', function() {
      if (this.value.trim().length < 20) {
        this.classList.add('blogflow-field-error');
        BlogFlowToast.info('SEO Tip', 'Description should be at least 20 characters', 2000);
      } else {
        this.classList.remove('blogflow-field-error');
        this.classList.add('blogflow-field-success');
      }
    });
  }
}

function handleFormSubmit(form, quillEditor, submitBtn) {
  console.log('[BlogFlow] Processing submission...');
  
  var originalText = submitBtn.textContent || submitBtn.innerText;
  submitBtn.disabled = true;
  submitBtn.innerHTML = 'Submitting<span class="blogflow-spinner"></span>';
  
  BlogFlowToast.info('Processing', 'Preparing your article...', 0);
  
  try {
    // Collect form data
    var formData = {};
    var inputs = form.querySelectorAll('input, textarea, select');
    
    console.log('[BlogFlow] Found ' + inputs.length + ' form inputs');
    
    for (var i = 0; i < inputs.length; i++) {
      var input = inputs[i];
      if (input.name && !input.name.startsWith('_')) {
        if (input.type === 'checkbox') {
          formData[input.name] = input.checked;
        } else if (input.type === 'radio') {
          if (input.checked) {
            formData[input.name] = input.value;
          }
        } else {
          formData[input.name] = input.value;
        }
        console.log('[BlogFlow] Field: ' + input.name + ' = ' + formData[input.name]);
      }
    }
    
    // SIMPLIFIED VALIDATION FOR DOCTORS
    var errors = [];
    
    if (!formData.authorName || formData.authorName.trim().length < 2) {
      errors.push('Please enter your name');
    }
    
    if (!formData.articleTitle || formData.articleTitle.trim().length < 5) {
      errors.push('Article title needs at least 5 characters');
    }
    
    if (!formData.metaDescription || formData.metaDescription.trim().length < 20) {
      errors.push('Brief description needs at least 20 characters');
    }
    
    // Add Quill content
    if (quillEditor) {
      var delta = quillEditor.getContents();
      var text = quillEditor.getText().trim();
      var wordCount = text.split(/\s+/).filter(function(word) {
        return word.length > 0;
      }).length;
      
      if (wordCount < 20) {
        errors.push('Article needs at least 20 words (you have ' + wordCount + ')');
      } else {
        formData.articleContent = delta;
      }
    } else {
      errors.push('Article content is required');
    }
    
    // Show errors if any
    if (errors.length > 0) {
      document.querySelectorAll('.blogflow-toast').forEach(function(toast) {
        toast.remove();
      });
      
      for (var j = 0; j < errors.length; j++) {
        (function(error, index) {
          setTimeout(function() {
            BlogFlowToast.warning('Required Field', error, 5000);
          }, index * 200);
        })(errors[j], j);
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      return;
    }
    
    // Process tags/categories
    if (formData.tags && typeof formData.tags === 'string') {
      formData.tags = formData.tags.split(',').map(function(tag) {
        return tag.trim();
      }).filter(Boolean);
    }
    
    if (formData.categories && typeof formData.categories === 'string') {
      formData.categories = formData.categories.split(',').map(function(cat) {
        return cat.trim();
      }).filter(Boolean);
    }
    
    // Handle checkbox
    if (formData.publishNow === 'on') {
      formData.publishNow = true;
    }
    
    // Auto-generate email
    formData.authorEmail = formData.authorEmail || 'doctor@' + window.location.hostname;
    
    console.log('[BlogFlow] Sending:', formData);
    
    // Make API request
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://dominiquede-blogflow-62.deno.dev/api/webflow-form', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    
    xhr.onload = function() {
      document.querySelectorAll('.blogflow-toast').forEach(function(toast) {
        toast.remove();
      });
      
      try {
        var response = JSON.parse(xhr.responseText);
        console.log('[BlogFlow] Response:', response);
        
        if (xhr.status === 200 && response.success) {
          BlogFlowToast.success('Success!', 'Your article has been published', 0);
          
          // Show success message
          form.style.display = 'none';
          var successDiv = document.createElement('div');
          successDiv.className = 'w-form-done';
          successDiv.style.display = 'block';
          successDiv.innerHTML = 
            '<div style="text-align: center; padding: 40px;">' +
              '<div style="font-size: 48px; color: #10b981; margin-bottom: 20px;">✓</div>' +
              '<h2>Article Published Successfully!</h2>' +
              '<p>Thank you for your contribution.</p>' +
              (response.data && response.data.itemId ? '<p style="color: #6b7280; margin-top: 10px;">Reference: ' + response.data.itemId + '</p>' : '') +
            '</div>';
          
          form.parentNode.insertBefore(successDiv, form.nextSibling);
          
          // Reset form
          form.reset();
          if (quillEditor) {
            quillEditor.setText('');
          }
        } else {
          // Handle specific errors
          if (response.message && response.message.includes('rate limit')) {
            BlogFlowToast.error('Too Many Requests', 'Please wait a moment and try again', 6000);
          } else if (response.fields) {
            // Show field-specific errors
            for (var field in response.fields) {
              if (response.fields.hasOwnProperty(field)) {
                BlogFlowToast.error('Validation Error', response.fields[field][0], 6000);
              }
            }
          } else {
            BlogFlowToast.error('Submission Failed', response.message || 'Please try again', 5000);
          }
        }
      } catch (e) {
        BlogFlowToast.error('Error', 'Invalid response from server', 5000);
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    };
    
    xhr.onerror = function() {
      document.querySelectorAll('.blogflow-toast').forEach(function(toast) {
        toast.remove();
      });
      
      BlogFlowToast.error('Connection Error', 'Please check your internet connection', 5000);
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    };
    
    xhr.send(JSON.stringify(formData));
    
  } catch (error) {
    console.error('[BlogFlow] Error:', error);
    BlogFlowToast.error('Error', error.message || 'Something went wrong', 5000);
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

console.log('[BlogFlow] Medical Professional Form Script Loaded - Button Fix Applied');
</script>